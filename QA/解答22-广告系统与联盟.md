# 问题22：广告系统、广告联盟处理和广告加载设计

## 概述

MkSaaS 支持多种广告系统集成，包括 Google AdSense、百度联盟等主流广告平台。本文详细介绍广告系统的架构设计、集成方法和优化策略。

## 一、广告系统架构

### 1. 整体架构

```
┌─────────────┐
│   页面组件   │
└──────┬──────┘
       │
┌──────▼──────┐
│  广告管理器  │ (统一管理)
└──────┬──────┘
       │
┌──────▼──────┐
│  广告适配器  │ (多平台支持)
└──────┬──────┘
       │
┌──────▼──────────────────┐
│  AdSense │ 百度 │ 其他  │
└─────────────────────────┘
```

### 2. 核心组件

```typescript
// src/lib/ads/types.ts
export interface AdConfig {
  provider: 'adsense' | 'baidu' | 'custom';
  enabled: boolean;
  slots: AdSlot[];
  settings: Record<string, any>;
}

export interface AdSlot {
  id: string;
  name: string;
  format: 'display' | 'in-article' | 'in-feed' | 'multiplex';
  size?: [number, number];
  responsive?: boolean;
}

export interface AdProvider {
  initialize(): Promise<void>;
  loadAd(slot: AdSlot, container: HTMLElement): Promise<void>;
  refreshAd(slotId: string): Promise<void>;
  destroy(): void;
}
```

## 二、Google AdSense 集成

### 1. 基础配置

```typescript
// src/lib/ads/providers/adsense.ts
export class AdSenseProvider implements AdProvider {
  private clientId: string;
  private initialized = false;
  
  constructor(clientId: string) {
    this.clientId = clientId;
  }
  
  async initialize(): Promise<void> {
    if (this.initialized) return;
    
    // 加载 AdSense 脚本
    await this.loadScript();
    
    // 初始化 AdSense
    (window.adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: this.clientId,
      enable_page_level_ads: true,
    });
    
    this.initialized = true;
  }
  
  private loadScript(): Promise<void> {
    return new Promise((resolve, reject) => {
      if (document.querySelector('script[src*="adsbygoogle"]')) {
        resolve();
        return;
      }
      
      const script = document.createElement('script');
      script.src = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${this.clientId}`;
      script.async = true;
      script.crossOrigin = 'anonymous';
      script.onload = () => resolve();
      script.onerror = () => reject(new Error('Failed to load AdSense'));
      
      document.head.appendChild(script);
    });
  }
  
  async loadAd(slot: AdSlot, container: HTMLElement): Promise<void> {
    await this.initialize();
    
    // 创建广告元素
    const ins = document.createElement('ins');
    ins.className = 'adsbygoogle';
    ins.style.display = 'block';
    ins.setAttribute('data-ad-client', this.clientId);
    ins.setAttribute('data-ad-slot', slot.id);
    
    if (slot.format) {
      ins.setAttribute('data-ad-format', slot.format);
    }
    
    if (slot.responsive) {
      ins.setAttribute('data-full-width-responsive', 'true');
    }
    
    container.appendChild(ins);
    
    // 请求广告
    try {
      (window.adsbygoogle = window.adsbygoogle || []).push({});
    } catch (error) {
      console.error('AdSense error:', error);
    }
  }
  
  async refreshAd(slotId: string): Promise<void> {
    // AdSense 不支持刷新，需要重新加载
    const container = document.querySelector(`[data-ad-slot="${slotId}"]`)?.parentElement;
    if (container) {
      container.innerHTML = '';
      await this.loadAd({ id: slotId } as AdSlot, container);
    }
  }
  
  destroy(): void {
    // 清理广告
    document.querySelectorAll('.adsbygoogle').forEach(el => el.remove());
  }
}
```

### 2. React 组件

```typescript
// src/components/ads/adsense.tsx
'use client';

import { useEffect, useRef } from 'react';

interface AdSenseProps {
  slot: string;
  format?: 'auto' | 'fluid' | 'rectangle';
  responsive?: boolean;
  style?: React.CSSProperties;
}

export function AdSense({
  slot,
  format = 'auto',
  responsive = true,
  style,
}: AdSenseProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    if (!containerRef.current) return;
    
    try {
      (window.adsbygoogle = window.adsbygoogle || []).push({});
    } catch (error) {
      console.error('AdSense error:', error);
    }
  }, []);
  
  return (
    <div ref={containerRef} style={style}>
      <ins
        className="adsbygoogle"
        style={{ display: 'block' }}
        data-ad-client={process.env.NEXT_PUBLIC_ADSENSE_CLIENT_ID}
        data-ad-slot={slot}
        data-ad-format={format}
        data-full-width-responsive={responsive.toString()}
      />
    </div>
  );
}
```

### 3. 使用示例

```typescript
// src/app/blog/[slug]/page.tsx
import { AdSense } from '@/components/ads/adsense';

export default function BlogPost() {
  return (
    <article>
      <h1>文章标题</h1>
      
      {/* 文章顶部广告 */}
      <AdSense
        slot="1234567890"
        format="auto"
        responsive
        style={{ marginBottom: '2rem' }}
      />
      
      <div className="content">
        {/* 文章内容 */}
      </div>
      
      {/* 文章底部广告 */}
      <AdSense
        slot="0987654321"
        format="auto"
        responsive
        style={{ marginTop: '2rem' }}
      />
    </article>
  );
}
```

## 三、百度联盟集成

### 1. 百度联盟配置

```typescript
// src/lib/ads/providers/baidu.ts
export class BaiduAdProvider implements AdProvider {
  private cpro_id: string;
  private initialized = false;
  
  constructor(cpro_id: string) {
    this.cpro_id = cpro_id;
  }
  
  async initialize(): Promise<void> {
    if (this.initialized) return;
    
    await this.loadScript();
    this.initialized = true;
  }
  
  private loadScript(): Promise<void> {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = `https://cpro.baidustatic.com/cpro/ui/c.js`;
      script.async = true;
      script.onload = () => resolve();
      script.onerror = () => reject(new Error('Failed to load Baidu Ad'));
      
      document.head.appendChild(script);
    });
  }
  
  async loadAd(slot: AdSlot, container: HTMLElement): Promise<void> {
    await this.initialize();
    
    // 创建广告容器
    const div = document.createElement('div');
    div.id = `baidu_ad_${slot.id}`;
    container.appendChild(div);
    
    // 加载广告
    const script = document.createElement('script');
    script.innerHTML = `
      (window.slotbydup = window.slotbydup || []).push({
        id: "${this.cpro_id}",
        container: "baidu_ad_${slot.id}",
        async: true
      });
    `;
    container.appendChild(script);
  }
  
  async refreshAd(slotId: string): Promise<void> {
    const container = document.getElementById(`baidu_ad_${slotId}`);
    if (container) {
      container.innerHTML = '';
      await this.loadAd({ id: slotId } as AdSlot, container.parentElement!);
    }
  }
  
  destroy(): void {
    document.querySelectorAll('[id^="baidu_ad_"]').forEach(el => el.remove());
  }
}
```

### 2. React 组件

```typescript
// src/components/ads/baidu.tsx
'use client';

import { useEffect, useRef } from 'react';

interface BaiduAdProps {
  slot: string;
  style?: React.CSSProperties;
}

export function BaiduAd({ slot, style }: BaiduAdProps) {
  const containerRef = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    if (!containerRef.current) return;
    
    const script = document.createElement('script');
    script.innerHTML = `
      (window.slotbydup = window.slotbydup || []).push({
        id: "${process.env.NEXT_PUBLIC_BAIDU_CPRO_ID}",
        container: "baidu_ad_${slot}",
        async: true
      });
    `;
    
    containerRef.current.appendChild(script);
    
    return () => {
      if (containerRef.current) {
        containerRef.current.innerHTML = '';
      }
    };
  }, [slot]);
  
  return (
    <div ref={containerRef} style={style}>
      <div id={`baidu_ad_${slot}`} />
    </div>
  );
}
```

## 四、广告管理系统

### 1. 广告管理器

```typescript
// src/lib/ads/manager.ts
export class AdManager {
  private providers: Map<string, AdProvider> = new Map();
  private slots: Map<string, AdSlot> = new Map();
  
  registerProvider(name: string, provider: AdProvider) {
    this.providers.set(name, provider);
  }
  
  registerSlot(slot: AdSlot) {
    this.slots.set(slot.id, slot);
  }
  
  async loadAd(
    slotId: string,
    container: HTMLElement,
    provider: string = 'adsense'
  ): Promise<void> {
    const slot = this.slots.get(slotId);
    const adProvider = this.providers.get(provider);
    
    if (!slot || !adProvider) {
      throw new Error('Slot or provider not found');
    }
    
    await adProvider.loadAd(slot, container);
  }
  
  async refreshAd(slotId: string, provider: string = 'adsense'): Promise<void> {
    const adProvider = this.providers.get(provider);
    
    if (!adProvider) {
      throw new Error('Provider not found');
    }
    
    await adProvider.refreshAd(slotId);
  }
  
  destroy() {
    this.providers.forEach(provider => provider.destroy());
    this.providers.clear();
    this.slots.clear();
  }
}

// 全局实例
export const adManager = new AdManager();
```


### 2. 广告配置管理

```typescript
// src/lib/ads/config.ts
export interface AdConfiguration {
  enabled: boolean;
  provider: 'adsense' | 'baidu' | 'custom';
  slots: {
    header: string;
    sidebar: string;
    inArticle: string;
    footer: string;
  };
  settings: {
    autoRefresh?: boolean;
    refreshInterval?: number;
    lazyLoad?: boolean;
    viewabilityThreshold?: number;
  };
}

export const adConfig: AdConfiguration = {
  enabled: process.env.NEXT_PUBLIC_ADS_ENABLED === 'true',
  provider: (process.env.NEXT_PUBLIC_AD_PROVIDER as any) || 'adsense',
  slots: {
    header: process.env.NEXT_PUBLIC_AD_SLOT_HEADER || '',
    sidebar: process.env.NEXT_PUBLIC_AD_SLOT_SIDEBAR || '',
    inArticle: process.env.NEXT_PUBLIC_AD_SLOT_IN_ARTICLE || '',
    footer: process.env.NEXT_PUBLIC_AD_SLOT_FOOTER || '',
  },
  settings: {
    autoRefresh: true,
    refreshInterval: 30000, // 30秒
    lazyLoad: true,
    viewabilityThreshold: 0.5, // 50%可见时加载
  },
};
```

### 3. 数据库模式

```typescript
// src/db/schema.ts
export const adSlots = pgTable('ad_slots', {
  id: text('id').primaryKey().$defaultFn(() => nanoid()),
  name: text('name').notNull(),
  provider: text('provider').notNull(),
  slotId: text('slot_id').notNull(),
  position: text('position').notNull(), // header, sidebar, in-article, footer
  enabled: boolean('enabled').default(true),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export const adImpressions = pgTable('ad_impressions', {
  id: text('id').primaryKey().$defaultFn(() => nanoid()),
  slotId: text('slot_id').notNull().references(() => adSlots.id),
  userId: text('user_id').references(() => users.id),
  pageUrl: text('page_url').notNull(),
  viewable: boolean('viewable').default(false),
  viewDuration: integer('view_duration'), // 毫秒
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

export const adClicks = pgTable('ad_clicks', {
  id: text('id').primaryKey().$defaultFn(() => nanoid()),
  impressionId: text('impression_id').notNull().references(() => adImpressions.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

## 五、广告加载优化

### 1. 懒加载实现

```typescript
// src/components/ads/lazy-ad.tsx
'use client';

import { useEffect, useRef, useState } from 'react';
import { useInView } from 'react-intersection-observer';

interface LazyAdProps {
  slot: string;
  provider?: 'adsense' | 'baidu';
  threshold?: number;
  children: React.ReactNode;
}

export function LazyAd({
  slot,
  provider = 'adsense',
  threshold = 0.5,
  children,
}: LazyAdProps) {
  const [shouldLoad, setShouldLoad] = useState(false);
  const { ref, inView } = useInView({
    threshold,
    triggerOnce: true,
  });
  
  useEffect(() => {
    if (inView) {
      setShouldLoad(true);
      
      // 记录曝光
      trackImpression(slot, provider);
    }
  }, [inView, slot, provider]);
  
  return (
    <div ref={ref}>
      {shouldLoad ? children : <AdPlaceholder />}
    </div>
  );
}

function AdPlaceholder() {
  return (
    <div
      style={{
        width: '100%',
        height: '250px',
        backgroundColor: '#f0f0f0',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
      }}
    >
      <span style={{ color: '#999' }}>广告加载中...</span>
    </div>
  );
}
```

### 2. 自动刷新

```typescript
// src/hooks/use-ad-refresh.ts
import { useEffect, useRef } from 'react';

export function useAdRefresh(
  slotId: string,
  interval: number = 30000,
  enabled: boolean = true
) {
  const timerRef = useRef<NodeJS.Timeout>();
  
  useEffect(() => {
    if (!enabled) return;
    
    timerRef.current = setInterval(() => {
      adManager.refreshAd(slotId);
    }, interval);
    
    return () => {
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    };
  }, [slotId, interval, enabled]);
}

// 使用示例
export function RefreshableAd({ slot }: { slot: string }) {
  useAdRefresh(slot, 30000, true);
  
  return <AdSense slot={slot} />;
}
```

### 3. 可见性追踪

```typescript
// src/lib/ads/tracking.ts
export function trackImpression(slotId: string, provider: string) {
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          // 记录曝光
          fetch('/api/ads/impression', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              slotId,
              provider,
              pageUrl: window.location.href,
              viewable: entry.intersectionRatio >= 0.5,
            }),
          });
          
          // 追踪可见时长
          const startTime = Date.now();
          
          const visibilityObserver = new IntersectionObserver(
            (entries) => {
              if (!entries[0].isIntersecting) {
                const duration = Date.now() - startTime;
                
                fetch('/api/ads/view-duration', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    slotId,
                    duration,
                  }),
                });
                
                visibilityObserver.disconnect();
              }
            },
            { threshold: 0.5 }
          );
          
          visibilityObserver.observe(entry.target);
          observer.disconnect();
        }
      });
    },
    { threshold: 0.5 }
  );
  
  const adElement = document.querySelector(`[data-ad-slot="${slotId}"]`);
  if (adElement) {
    observer.observe(adElement);
  }
}
```

## 六、广告收益分析

### 1. 收益统计

```typescript
// src/lib/ads/analytics.ts
export async function getAdRevenue(startDate: Date, endDate: Date) {
  const impressions = await db
    .select({
      slotId: adImpressions.slotId,
      count: count(),
      viewable: count(adImpressions.viewable).where(eq(adImpressions.viewable, true)),
    })
    .from(adImpressions)
    .where(
      and(
        gte(adImpressions.createdAt, startDate),
        lte(adImpressions.createdAt, endDate)
      )
    )
    .groupBy(adImpressions.slotId);
  
  const clicks = await db
    .select({
      slotId: adImpressions.slotId,
      count: count(),
    })
    .from(adClicks)
    .innerJoin(adImpressions, eq(adClicks.impressionId, adImpressions.id))
    .where(
      and(
        gte(adClicks.createdAt, startDate),
        lte(adClicks.createdAt, endDate)
      )
    )
    .groupBy(adImpressions.slotId);
  
  return impressions.map((imp) => {
    const click = clicks.find((c) => c.slotId === imp.slotId);
    const ctr = click ? (click.count / imp.count) * 100 : 0;
    const viewability = (imp.viewable / imp.count) * 100;
    
    return {
      slotId: imp.slotId,
      impressions: imp.count,
      clicks: click?.count || 0,
      ctr,
      viewability,
    };
  });
}
```

### 2. 性能监控

```typescript
// src/lib/ads/performance.ts
export function monitorAdPerformance() {
  // 监控广告加载时间
  const observer = new PerformanceObserver((list) => {
    list.getEntries().forEach((entry) => {
      if (entry.name.includes('googlesyndication') || entry.name.includes('baidustatic')) {
        console.log('Ad load time:', entry.duration);
        
        // 发送到分析服务
        fetch('/api/analytics/ad-performance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url: entry.name,
            duration: entry.duration,
            size: (entry as any).transferSize,
          }),
        });
      }
    });
  });
  
  observer.observe({ entryTypes: ['resource'] });
}
```

## 七、广告屏蔽检测

### 1. 检测实现

```typescript
// src/lib/ads/adblock-detector.ts
export async function detectAdBlocker(): Promise<boolean> {
  try {
    // 尝试加载广告脚本
    const response = await fetch(
      'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js',
      {
        method: 'HEAD',
        mode: 'no-cors',
      }
    );
    
    return false; // 未被屏蔽
  } catch (error) {
    return true; // 被屏蔽
  }
}

// 使用示例
export function AdBlockerNotice() {
  const [isBlocked, setIsBlocked] = useState(false);
  
  useEffect(() => {
    detectAdBlocker().then(setIsBlocked);
  }, []);
  
  if (!isBlocked) return null;
  
  return (
    <div className="ad-blocker-notice">
      <p>检测到广告屏蔽插件</p>
      <p>请考虑关闭广告屏蔽以支持我们</p>
    </div>
  );
}
```

### 2. 替代方案

```typescript
// src/components/ads/fallback-ad.tsx
export function FallbackAd() {
  return (
    <div className="fallback-ad">
      <a href="/premium" className="premium-cta">
        <h3>升级到高级版</h3>
        <p>无广告体验 + 更多功能</p>
        <button>立即升级</button>
      </a>
    </div>
  );
}

// 使用示例
export function AdWithFallback({ slot }: { slot: string }) {
  const [isBlocked, setIsBlocked] = useState(false);
  
  useEffect(() => {
    detectAdBlocker().then(setIsBlocked);
  }, []);
  
  if (isBlocked) {
    return <FallbackAd />;
  }
  
  return <AdSense slot={slot} />;
}
```

## 八、环境配置

### 1. 环境变量

```env
# .env.local

# 广告开关
NEXT_PUBLIC_ADS_ENABLED=true

# 广告提供商
NEXT_PUBLIC_AD_PROVIDER=adsense

# Google AdSense
NEXT_PUBLIC_ADSENSE_CLIENT_ID=ca-pub-1234567890123456
NEXT_PUBLIC_AD_SLOT_HEADER=1234567890
NEXT_PUBLIC_AD_SLOT_SIDEBAR=0987654321
NEXT_PUBLIC_AD_SLOT_IN_ARTICLE=1122334455
NEXT_PUBLIC_AD_SLOT_FOOTER=5544332211

# 百度联盟
NEXT_PUBLIC_BAIDU_CPRO_ID=u1234567

# 广告设置
NEXT_PUBLIC_AD_AUTO_REFRESH=true
NEXT_PUBLIC_AD_REFRESH_INTERVAL=30000
NEXT_PUBLIC_AD_LAZY_LOAD=true
```

### 2. Next.js 配置

```typescript
// next.config.js
module.exports = {
  // 允许加载广告脚本
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: [
              "script-src 'self' 'unsafe-inline' 'unsafe-eval'",
              'https://pagead2.googlesyndication.com',
              'https://adservice.google.com',
              'https://cpro.baidustatic.com',
            ].join(' '),
          },
        ],
      },
    ];
  },
};
```

## 九、最佳实践

### 1. 广告位置

```typescript
// 推荐的广告位置
export const AD_POSITIONS = {
  // 页面顶部 - 高可见性
  header: {
    format: 'horizontal',
    size: [728, 90],
    priority: 'high',
  },
  
  // 侧边栏 - 持续可见
  sidebar: {
    format: 'vertical',
    size: [300, 600],
    priority: 'medium',
  },
  
  // 文章内 - 高参与度
  inArticle: {
    format: 'rectangle',
    size: [300, 250],
    priority: 'high',
  },
  
  // 页面底部 - 低优先级
  footer: {
    format: 'horizontal',
    size: [728, 90],
    priority: 'low',
  },
};
```

### 2. 性能优化

```typescript
// 延迟加载广告脚本
export function loadAdScriptAsync() {
  if (typeof window === 'undefined') return;
  
  // 等待页面加载完成
  if (document.readyState === 'complete') {
    loadAdScript();
  } else {
    window.addEventListener('load', loadAdScript);
  }
}

function loadAdScript() {
  // 延迟3秒加载广告
  setTimeout(() => {
    const script = document.createElement('script');
    script.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js';
    script.async = true;
    document.head.appendChild(script);
  }, 3000);
}
```

### 3. 用户体验

```typescript
// 广告加载状态
export function AdWithLoading({ slot }: { slot: string }) {
  const [isLoading, setIsLoading] = useState(true);
  
  useEffect(() => {
    const timer = setTimeout(() => setIsLoading(false), 2000);
    return () => clearTimeout(timer);
  }, []);
  
  return (
    <div className="ad-container">
      {isLoading && (
        <div className="ad-skeleton">
          <div className="skeleton-line" />
          <div className="skeleton-line" />
          <div className="skeleton-line" />
        </div>
      )}
      <AdSense slot={slot} />
    </div>
  );
}
```

## 十、合规性

### 1. GDPR 合规

```typescript
// src/lib/ads/consent.ts
export async function checkAdConsent(): Promise<boolean> {
  // 检查用户是否同意广告
  const consent = localStorage.getItem('ad_consent');
  
  if (consent === null) {
    // 显示同意对话框
    return showConsentDialog();
  }
  
  return consent === 'true';
}

export function showConsentDialog(): Promise<boolean> {
  return new Promise((resolve) => {
    // 显示对话框
    const dialog = document.createElement('div');
    dialog.innerHTML = `
      <div class="consent-dialog">
        <p>我们使用广告来支持网站运营</p>
        <button id="accept">接受</button>
        <button id="reject">拒绝</button>
      </div>
    `;
    
    document.body.appendChild(dialog);
    
    dialog.querySelector('#accept')?.addEventListener('click', () => {
      localStorage.setItem('ad_consent', 'true');
      dialog.remove();
      resolve(true);
    });
    
    dialog.querySelector('#reject')?.addEventListener('click', () => {
      localStorage.setItem('ad_consent', 'false');
      dialog.remove();
      resolve(false);
    });
  });
}
```

## 总结

MkSaaS 提供了完整的广告系统解决方案：

1. **多平台支持**: Google AdSense、百度联盟等
2. **智能加载**: 懒加载、自动刷新、可见性追踪
3. **性能优化**: 延迟加载、异步加载、缓存策略
4. **收益分析**: 曝光、点击、CTR 等指标
5. **用户体验**: 广告屏蔽检测、替代方案
6. **合规性**: GDPR、隐私政策

通过这些功能，可以构建高效、合规的广告变现系统。
