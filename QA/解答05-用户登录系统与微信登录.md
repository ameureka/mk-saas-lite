# 问题5：用户登录系统的逻辑是什么，如何有效地集成微信登录

## 用户登录系统逻辑

### 登录流程架构

```
用户 → 前端登录表单 → Better Auth API → 数据库验证 → 创建 Session → 返回 Cookie → 重定向
```

### 支持的登录方式

1. **邮箱密码登录** (Credential Login)
2. **GitHub OAuth**
3. **Google OAuth**
4. **微信登录** (需要集成)

## 当前登录实现

### 1. 邮箱密码登录

```typescript
// 配置
emailAndPassword: {
  enabled: true,
  requireEmailVerification: true,
}

// 前端调用
await signIn.email({
  email: 'user@example.com',
  password: 'password123',
});
```

### 2. GitHub 登录

```typescript
// 配置
socialProviders: {
  github: {
    clientId: process.env.GITHUB_CLIENT_ID!,
    clientSecret: process.env.GITHUB_CLIENT_SECRET!,
  },
}

// 前端调用
await signIn.social({
  provider: 'github',
  callbackURL: '/dashboard',
});
```

### 3. Google 登录

```typescript
// 配置
socialProviders: {
  google: {
    clientId: process.env.GOOGLE_CLIENT_ID!,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
  },
}

// 前端调用
await signIn.social({
  provider: 'google',
  callbackURL: '/dashboard',
});
```

## 如何集成微信登录

Better Auth 支持自定义 OAuth 提供商，可以集成微信登录。

### 方案一：使用 Better Auth 自定义 OAuth

#### 1. 注册微信开放平台应用

访问 [微信开放平台](https://open.weixin.qq.com/)：
- 注册开发者账号
- 创建网站应用
- 获取 AppID 和 AppSecret
- 配置授权回调域名

#### 2. 添加环境变量

```env
# 微信登录
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-app-secret
```

#### 3. 配置 Better Auth

```typescript
// src/lib/auth.ts
import { betterAuth } from 'better-auth';

export const auth = betterAuth({
  // ... 其他配置
  
  socialProviders: {
    // ... 其他提供商
    
    // 微信登录配置
    wechat: {
      clientId: process.env.WECHAT_APP_ID!,
      clientSecret: process.env.WECHAT_APP_SECRET!,
      // 微信 OAuth 端点
      authorizationEndpoint: 'https://open.weixin.qq.com/connect/qrconnect',
      tokenEndpoint: 'https://api.weixin.qq.com/sns/oauth2/access_token',
      userInfoEndpoint: 'https://api.weixin.qq.com/sns/userinfo',
      // 作用域
      scope: ['snsapi_login'],
      // 字段映射
      profile(profile) {
        return {
          id: profile.unionid,
          name: profile.nickname,
          email: null, // 微信不提供邮箱
          image: profile.headimgurl,
        };
      },
    },
  },
});
```

#### 4. 前端调用

```typescript
// 微信登录按钮
<button onClick={() => signIn.social({
  provider: 'wechat',
  callbackURL: '/dashboard',
})}>
  <WeChatIcon />
  微信登录
</button>
```

### 方案二：使用微信 JS-SDK（移动端）

适用于微信内置浏览器环境。

#### 1. 安装依赖

```bash
pnpm add weixin-js-sdk
pnpm add -D @types/weixin-js-sdk
```

#### 2. 创建微信登录服务

```typescript
// src/lib/wechat.ts
import wx from 'weixin-js-sdk';

export async function wechatLogin() {
  return new Promise((resolve, reject) => {
    wx.ready(() => {
      wx.checkJsApi({
        jsApiList: ['login'],
        success: (res) => {
          if (res.checkResult.login) {
            wx.login({
              success: (loginRes) => {
                resolve(loginRes.code);
              },
              fail: reject,
            });
          }
        },
      });
    });
  });
}
```

#### 3. 后端处理微信登录

```typescript
// src/app/api/auth/wechat/route.ts
import { NextRequest, NextResponse } from 'next/server';

export async function POST(req: NextRequest) {
  const { code } = await req.json();
  
  // 1. 使用 code 换取 access_token
  const tokenResponse = await fetch(
    `https://api.weixin.qq.com/sns/oauth2/access_token?` +
    `appid=${process.env.WECHAT_APP_ID}&` +
    `secret=${process.env.WECHAT_APP_SECRET}&` +
    `code=${code}&` +
    `grant_type=authorization_code`
  );
  
  const tokenData = await tokenResponse.json();
  
  if (tokenData.errcode) {
    return NextResponse.json(
      { error: tokenData.errmsg },
      { status: 400 }
    );
  }
  
  // 2. 获取用户信息
  const userResponse = await fetch(
    `https://api.weixin.qq.com/sns/userinfo?` +
    `access_token=${tokenData.access_token}&` +
    `openid=${tokenData.openid}`
  );
  
  const userData = await userResponse.json();
  
  // 3. 创建或更新用户
  const user = await createOrUpdateWechatUser({
    unionid: userData.unionid,
    openid: userData.openid,
    nickname: userData.nickname,
    headimgurl: userData.headimgurl,
  });
  
  // 4. 创建 session
  const session = await auth.api.createSession({
    userId: user.id,
  });
  
  return NextResponse.json({ session });
}
```

### 方案三：使用第三方服务（推荐）

使用 [Authing](https://www.authing.cn/) 或 [Auth0](https://auth0.com/) 等服务，它们已经集成了微信登录。

#### 使用 Authing

```typescript
// 1. 安装 SDK
pnpm add @authing/web

// 2. 初始化
import { Authing } from '@authing/web';

const authing = new Authing({
  appId: process.env.AUTHING_APP_ID!,
  appHost: process.env.AUTHING_APP_HOST!,
  redirectUri: 'https://yourdomain.com/callback',
});

// 3. 微信登录
await authing.loginWithWechat();
```

## 微信登录特殊处理

### 1. 邮箱问题

微信不提供邮箱，需要特殊处理：

```typescript
// 创建虚拟邮箱
const email = `wechat_${unionid}@placeholder.com`;

// 或要求用户补充邮箱
if (!user.email) {
  // 跳转到邮箱绑定页面
  redirect('/auth/bind-email');
}
```

### 2. UnionID vs OpenID

- **OpenID**: 用户在单个应用的唯一标识
- **UnionID**: 用户在同一开放平台账号下所有应用的唯一标识

建议使用 UnionID 作为用户标识。

### 3. 账户关联

允许用户将微信账号与已有账号关联：

```typescript
// Better Auth 账户关联配置
account: {
  accountLinking: {
    enabled: true,
    trustedProviders: ['google', 'github', 'wechat'],
  },
}
```

## 完整的微信登录流程

### 1. 用户点击微信登录按钮

```tsx
<button onClick={handleWechatLogin}>
  <WeChatIcon />
  微信登录
</button>
```

### 2. 跳转到微信授权页面

```typescript
const handleWechatLogin = () => {
  const appId = process.env.NEXT_PUBLIC_WECHAT_APP_ID;
  const redirectUri = encodeURIComponent(
    'https://yourdomain.com/api/auth/wechat/callback'
  );
  const state = generateRandomState();
  
  window.location.href = 
    `https://open.weixin.qq.com/connect/qrconnect?` +
    `appid=${appId}&` +
    `redirect_uri=${redirectUri}&` +
    `response_type=code&` +
    `scope=snsapi_login&` +
    `state=${state}#wechat_redirect`;
};
```

### 3. 微信回调

```typescript
// src/app/api/auth/wechat/callback/route.ts
export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);
  const code = searchParams.get('code');
  const state = searchParams.get('state');
  
  // 验证 state
  if (!verifyState(state)) {
    return NextResponse.redirect('/auth/error');
  }
  
  // 换取 access_token
  const tokenData = await getWechatAccessToken(code);
  
  // 获取用户信息
  const userData = await getWechatUserInfo(
    tokenData.access_token,
    tokenData.openid
  );
  
  // 创建或更新用户
  const user = await findOrCreateUser({
    provider: 'wechat',
    providerId: userData.unionid,
    name: userData.nickname,
    image: userData.headimgurl,
  });
  
  // 创建 session
  const session = await auth.api.createSession({
    userId: user.id,
  });
  
  // 设置 cookie 并重定向
  return NextResponse.redirect('/dashboard');
}
```

### 4. 创建或更新用户

```typescript
async function findOrCreateUser(data: {
  provider: string;
  providerId: string;
  name: string;
  image: string;
}) {
  // 查找现有账户
  const existingAccount = await db
    .select()
    .from(account)
    .where(
      and(
        eq(account.providerId, data.provider),
        eq(account.accountId, data.providerId)
      )
    )
    .limit(1);
  
  if (existingAccount.length > 0) {
    // 返回现有用户
    return await db
      .select()
      .from(user)
      .where(eq(user.id, existingAccount[0].userId))
      .limit(1);
  }
  
  // 创建新用户
  const newUser = await db
    .insert(user)
    .values({
      id: nanoid(),
      name: data.name,
      email: `wechat_${data.providerId}@placeholder.com`,
      emailVerified: false,
      image: data.image,
      createdAt: new Date(),
      updatedAt: new Date(),
    })
    .returning();
  
  // 创建账户记录
  await db.insert(account).values({
    id: nanoid(),
    userId: newUser[0].id,
    providerId: data.provider,
    accountId: data.providerId,
    createdAt: new Date(),
    updatedAt: new Date(),
  });
  
  return newUser[0];
}
```

## 微信登录 UI 组件

```tsx
// src/components/auth/wechat-login-button.tsx
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { WechatIcon } from '@/components/icons/wechat';

export function WechatLoginButton() {
  const [isLoading, setIsLoading] = useState(false);
  
  const handleLogin = async () => {
    setIsLoading(true);
    
    try {
      // 方案1: 使用 Better Auth
      await signIn.social({
        provider: 'wechat',
        callbackURL: '/dashboard',
      });
      
      // 方案2: 自定义跳转
      // window.location.href = getWechatAuthUrl();
    } catch (error) {
      console.error('微信登录失败:', error);
    } finally {
      setIsLoading(false);
    }
  };
  
  return (
    <Button
      onClick={handleLogin}
      disabled={isLoading}
      variant="outline"
      className="w-full"
    >
      <WechatIcon className="mr-2 h-4 w-4" />
      {isLoading ? '登录中...' : '微信登录'}
    </Button>
  );
}
```

## 环境变量配置

```env
# 微信开放平台
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_APP_SECRET=your-wechat-app-secret

# 微信公众平台（如果需要）
WECHAT_MP_APP_ID=wx1234567890abcdef
WECHAT_MP_APP_SECRET=your-mp-app-secret
```

## 测试微信登录

### 1. 开发环境

微信要求使用已备案的域名，开发环境可以：
- 使用内网穿透工具（ngrok, frp）
- 使用测试账号
- 使用微信开发者工具

### 2. 测试流程

1. 配置测试域名
2. 扫码登录
3. 授权
4. 验证用户信息
5. 检查 session 创建

## 安全注意事项

1. **验证 state 参数**: 防止 CSRF 攻击
2. **HTTPS 必须**: 微信要求使用 HTTPS
3. **Token 安全**: 不要在前端暴露 AppSecret
4. **用户隐私**: 遵守微信用户协议
5. **错误处理**: 优雅处理授权失败

## 总结

集成微信登录的步骤：

1. 注册微信开放平台应用
2. 配置 Better Auth 或自定义 OAuth
3. 实现前端登录按钮
4. 处理微信回调
5. 创建或关联用户账户
6. 处理特殊情况（无邮箱等）

推荐使用 Better Auth 的自定义 OAuth 功能或第三方服务（Authing）来简化集成过程。
