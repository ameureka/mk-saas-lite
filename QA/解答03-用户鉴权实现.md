# 问题3：用户鉴权是如何实现的？

## 概述

MkSaaS 使用 **Better Auth** 作为认证解决方案，这是一个现代化的、类型安全的 Next.js 认证库，支持多种登录方式和高级功能。

## 核心技术

- **Better Auth**: 主认证库
- **Drizzle ORM**: 数据库适配器
- **PostgreSQL**: 数据库
- **Next.js Middleware**: 路由保护
- **Cookies**: Session 管理

## 数据库 Schema

### 1. 用户表 (user)
```typescript
export const user = pgTable("user", {
  id: text("id").primaryKey(),
  name: text('name').notNull(),
  email: text('email').notNull().unique(),
  emailVerified: boolean('email_verified').notNull(),
  image: text('image'),
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at').notNull(),
  role: text('role'),                    // 用户角色
  banned: boolean('banned'),             // 是否被封禁
  banReason: text('ban_reason'),         // 封禁原因
  banExpires: timestamp('ban_expires'),  // 封禁过期时间
  customerId: text('customer_id'),       // Stripe 客户 ID
});
```

### 2. 会话表 (session)
```typescript
export const session = pgTable("session", {
  id: text("id").primaryKey(),
  expiresAt: timestamp('expires_at').notNull(),
  token: text('token').notNull().unique(),
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at').notNull(),
  ipAddress: text('ip_address'),
  userAgent: text('user_agent'),
  userId: text('user_id').notNull().references(() => user.id),
  impersonatedBy: text('impersonated_by'),  // 管理员模拟登录
});
```

### 3. 账户表 (account)
```typescript
export const account = pgTable("account", {
  id: text("id").primaryKey(),
  accountId: text('account_id').notNull(),
  providerId: text('provider_id').notNull(),  // github, google, email
  userId: text('user_id').notNull().references(() => user.id),
  accessToken: text('access_token'),
  refreshToken: text('refresh_token'),
  idToken: text('id_token'),
  accessTokenExpiresAt: timestamp('access_token_expires_at'),
  refreshTokenExpiresAt: timestamp('refresh_token_expires_at'),
  scope: text('scope'),
  password: text('password'),  // 仅用于邮箱密码登录
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at').notNull()
});
```

### 4. 验证表 (verification)
```typescript
export const verification = pgTable("verification", {
  id: text("id").primaryKey(),
  identifier: text('identifier').notNull(),  // 邮箱或手机号
  value: text('value').notNull(),            // 验证码或 token
  expiresAt: timestamp('expires_at').notNull(),
  createdAt: timestamp('created_at'),
  updatedAt: timestamp('updated_at')
});
```

## Better Auth 配置

### 核心配置 (src/lib/auth.ts)

```typescript
export const auth = betterAuth({
  baseURL: getBaseUrl(),
  appName: "MkSaaS",
  
  // 数据库适配器
  database: drizzleAdapter(await getDb(), {
    provider: 'pg',
  }),
  
  // Session 配置
  session: {
    cookieCache: {
      enabled: true,
      maxAge: 60 * 60,  // 1小时缓存
    },
    expiresIn: 60 * 60 * 24 * 7,  // 7天过期
    updateAge: 60 * 60 * 24,       // 24小时更新
    freshAge: 0,                    // 禁用新鲜度检查
  },
  
  // 邮箱密码登录
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: true,
    async sendResetPassword({ user, url }, request) {
      const locale = getLocaleFromRequest(request);
      await sendEmail({
        to: user.email,
        template: 'forgotPassword',
        context: { url, name: user.name },
        locale,
      });
    },
  },
  
  // 邮箱验证
  emailVerification: {
    autoSignInAfterVerification: true,
    sendVerificationEmail: async ({ user, url }, request) => {
      const locale = getLocaleFromRequest(request);
      await sendEmail({
        to: user.email,
        template: 'verifyEmail',
        context: { url, name: user.name },
        locale,
      });
    },
  },
  
  // 社交登录
  socialProviders: {
    github: {
      clientId: process.env.GITHUB_CLIENT_ID!,
      clientSecret: process.env.GITHUB_CLIENT_SECRET!,
    },
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    },
  },
  
  // 账户关联
  account: {
    accountLinking: {
      enabled: true,
      trustedProviders: ['google', 'github'],
    },
  },
  
  // 用户扩展字段
  user: {
    additionalFields: {
      customerId: {
        type: 'string',
        required: false,
      },
    },
    deleteUser: {
      enabled: true,
    },
  },
  
  // 数据库钩子
  databaseHooks: {
    user: {
      create: {
        after: async (user) => {
          await onCreateUser(user);
        },
      },
    },
  },
  
  // 插件
  plugins: [
    admin({
      defaultBanExpiresIn: undefined,
      bannedUserMessage: 'You have been banned from this application.',
    }),
  ],
  
  // 错误处理
  onAPIError: {
    errorURL: '/auth/error',
    onError: (error, ctx) => {
      console.error('auth error:', error);
    },
  },
});
```

## 登录方式配置

在 `src/config/website.tsx` 中控制启用的登录方式：

```typescript
auth: {
  enableGoogleLogin: true,
  enableGithubLogin: true,
  enableCredentialLogin: true,  // 邮箱密码登录
}
```

## 路由保护

### Middleware 实现 (src/middleware.ts)

```typescript
export default async function middleware(req: NextRequest) {
  const { nextUrl } = req;
  
  // 获取 session
  const { data: session } = await betterFetch<Session>(
    '/api/auth/get-session',
    {
      baseURL: getBaseUrl(),
      headers: {
        cookie: req.headers.get('cookie') || '',
      },
    }
  );
  const isLoggedIn = !!session;
  
  // 获取不带语言前缀的路径
  const pathnameWithoutLocale = getPathnameWithoutLocale(
    nextUrl.pathname,
    LOCALES
  );
  
  // 已登录用户不能访问的路由（如登录、注册页）
  if (isLoggedIn) {
    const isNotAllowedRoute = routesNotAllowedByLoggedInUsers.some((route) =>
      new RegExp(`^${route}$`).test(pathnameWithoutLocale)
    );
    if (isNotAllowedRoute) {
      return NextResponse.redirect(new URL(DEFAULT_LOGIN_REDIRECT, nextUrl));
    }
  }
  
  // 需要登录才能访问的路由
  const isProtectedRoute = protectedRoutes.some((route) =>
    new RegExp(`^${route}$`).test(pathnameWithoutLocale)
  );
  
  if (!isLoggedIn && isProtectedRoute) {
    let callbackUrl = nextUrl.pathname;
    if (nextUrl.search) {
      callbackUrl += nextUrl.search;
    }
    const encodedCallbackUrl = encodeURIComponent(callbackUrl);
    return NextResponse.redirect(
      new URL(`/auth/login?callbackUrl=${encodedCallbackUrl}`, nextUrl)
    );
  }
  
  // 应用国际化中间件
  return intlMiddleware(req);
}
```

### 路由定义 (src/routes.ts)

```typescript
// 已登录用户不能访问的路由
export const routesNotAllowedByLoggedInUsers = [
  Routes.Login, 
  Routes.Register
];

// 需要登录才能访问的路由
export const protectedRoutes = [
  Routes.Dashboard,
  Routes.AdminUsers,
  Routes.SettingsProfile,
  Routes.SettingsBilling,
  Routes.SettingsCredits,
  Routes.SettingsSecurity,
  Routes.SettingsNotifications,
  Routes.Payment,
];

// 登录后默认跳转路径
export const DEFAULT_LOGIN_REDIRECT = '/settings/profile';
```

## 用户注册流程

### 1. 用户提交注册表单
```typescript
// 前端调用
await signUp.email({
  email: 'user@example.com',
  password: 'password123',
  name: 'John Doe',
});
```

### 2. Better Auth 创建用户
- 生成用户 ID
- 哈希密码
- 创建用户记录
- 创建账户记录

### 3. 触发 onCreateUser 钩子
```typescript
async function onCreateUser(user: User) {
  // 1. 自动订阅 Newsletter（延迟2秒避免限流）
  if (websiteConfig.newsletter.autoSubscribeAfterSignUp) {
    setTimeout(async () => {
      await subscribe(user.email);
    }, 2000);
  }
  
  // 2. 赠送注册积分
  if (websiteConfig.credits.registerGiftCredits.enable) {
    await addRegisterGiftCredits(user.id);
  }
  
  // 3. 添加免费计划月度积分
  const freePlan = pricePlans.find(plan => plan.isFree);
  if (freePlan) {
    await addMonthlyFreeCredits(user.id, freePlan.id);
  }
}
```

### 4. 发送验证邮件
```typescript
await sendEmail({
  to: user.email,
  template: 'verifyEmail',
  context: {
    url: verificationUrl,
    name: user.name,
  },
  locale: 'en',
});
```

### 5. 用户点击验证链接
- 验证 token
- 标记邮箱已验证
- 自动登录（如果启用）

## 登录流程

### 邮箱密码登录
```typescript
await signIn.email({
  email: 'user@example.com',
  password: 'password123',
});
```

### 社交登录
```typescript
// GitHub 登录
await signIn.social({
  provider: 'github',
  callbackURL: '/dashboard',
});

// Google 登录
await signIn.social({
  provider: 'google',
  callbackURL: '/dashboard',
});
```

## Session 管理

### Cookie 配置
- **名称**: `better-auth.session_token`
- **过期时间**: 7 天
- **更新频率**: 24 小时
- **缓存时间**: 1 小时

### 获取当前用户
```typescript
import { auth } from '@/lib/auth';

// 服务端
const session = await auth.api.getSession({
  headers: headers(),
});

// 客户端
const { data: session } = useSession();
```

## 权限管理

### 角色系统
```typescript
// 用户角色
user.role = 'admin' | 'user' | null;

// 检查权限
if (session.user.role === 'admin') {
  // 管理员操作
}
```

### Admin 插件功能
- 用户管理
- 封禁/解封用户
- 角色管理
- 模拟登录（impersonation）

## 密码重置流程

### 1. 用户请求重置
```typescript
await forgetPassword({
  email: 'user@example.com',
  redirectTo: '/auth/reset-password',
});
```

### 2. 发送重置邮件
```typescript
await sendEmail({
  to: user.email,
  template: 'forgotPassword',
  context: {
    url: resetUrl,
    name: user.name,
  },
  locale: 'en',
});
```

### 3. 用户设置新密码
```typescript
await resetPassword({
  token: 'reset-token',
  password: 'newPassword123',
});
```

## 账户关联

Better Auth 支持将多个登录方式关联到同一账户：

```typescript
account: {
  accountLinking: {
    enabled: true,
    trustedProviders: ['google', 'github'],
  },
}
```

用户可以：
- 使用邮箱密码注册
- 后续关联 GitHub 账户
- 后续关联 Google 账户
- 使用任意方式登录同一账户

## 安全特性

### 1. 密码哈希
使用 bcrypt 或 argon2 哈希密码

### 2. CSRF 保护
自动处理 CSRF token

### 3. Session 固定攻击防护
登录后自动刷新 session

### 4. 邮箱验证
强制要求邮箱验证后才能使用

### 5. 速率限制
防止暴力破解（需要额外配置）

## 环境变量

```env
# Better Auth
BETTER_AUTH_SECRET=your-secret-key
BETTER_AUTH_URL=https://yourdomain.com

# GitHub OAuth
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Database
DATABASE_URL=postgresql://user:password@host:5432/database
```

## API 路由

Better Auth 自动创建以下 API 路由：

```
POST   /api/auth/sign-in/email
POST   /api/auth/sign-up/email
POST   /api/auth/sign-in/social
GET    /api/auth/get-session
POST   /api/auth/sign-out
POST   /api/auth/forget-password
POST   /api/auth/reset-password
POST   /api/auth/verify-email
GET    /api/auth/callback/[provider]
```

## 客户端 Hooks

```typescript
import { useSession } from '@/lib/auth-client';

function MyComponent() {
  const { data: session, isPending } = useSession();
  
  if (isPending) return <div>Loading...</div>;
  if (!session) return <div>Not logged in</div>;
  
  return <div>Welcome, {session.user.name}!</div>;
}
```

## 最佳实践

1. **始终验证邮箱**: 防止垃圾注册
2. **使用 HTTPS**: 保护 session cookie
3. **定期更新 session**: 防止 session 劫持
4. **记录登录日志**: 追踪异常登录
5. **实现双因素认证**: 增强安全性（可选）

## 总结

MkSaaS 的认证系统基于 Better Auth，提供了完整的用户认证解决方案，支持多种登录方式、邮箱验证、密码重置、账户关联等功能，并通过 Next.js Middleware 实现路由保护，确保应用的安全性。
