# 问题2：是否有积分体系

## 概述

MkSaaS 实现了完整的积分（Credits）体系，用于控制用户对 AI 功能和其他付费功能的使用。积分系统支持购买、消费、过期管理和交易记录。

## 积分系统架构

### 数据库设计

#### 1. 用户积分表 (user_credit)

```typescript
export const userCredit = pgTable("user_credit", {
  id: text("id").primaryKey(),
  userId: text("user_id").notNull().references(() => user.id, { onDelete: 'cascade' }),
  currentCredits: integer("current_credits").notNull().default(0),
  lastRefreshAt: timestamp("last_refresh_at"), // 已废弃
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});
```

#### 2. 积分交易表 (credit_transaction)

```typescript
export const creditTransaction = pgTable("credit_transaction", {
  id: text("id").primaryKey(),
  userId: text("user_id").notNull().references(() => user.id, { onDelete: 'cascade' }),
  type: text("type").notNull(),  // 交易类型：purchase, consume, gift, refund 等
  description: text("description"),
  amount: integer("amount").notNull(),
  remainingAmount: integer("remaining_amount"),
  paymentId: text("payment_id"),  // 实际存储的是 invoiceId
  expirationDate: timestamp("expiration_date"),
  expirationDateProcessedAt: timestamp("expiration_date_processed_at"),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});
```

## 积分配置

在 `src/config/website.tsx` 中配置积分系统：

```typescript
credits: {
  enableCredits: false,  // 是否启用积分系统
  enablePackagesForFreePlan: false,  // 免费用户是否可购买积分包
  
  // 注册赠送积分
  registerGiftCredits: {
    enable: true,
    amount: 50,
    expireDays: 30,
  },
  
  // 积分包配置
  packages: {
    basic: {
      id: 'basic',
      popular: false,
      amount: 100,
      expireDays: 30,
      price: {
        priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_CREDITS_BASIC!,
        amount: 990,  // $9.90
        currency: 'USD',
        allowPromotionCode: true,
      },
    },
    standard: {
      id: 'standard',
      popular: true,
      amount: 200,
      expireDays: 30,
      price: {
        priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_CREDITS_STANDARD!,
        amount: 1490,  // $14.90
        currency: 'USD',
        allowPromotionCode: true,
      },
    },
    premium: {
      id: 'premium',
      popular: false,
      amount: 500,
      expireDays: 30,
      price: {
        priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_CREDITS_PREMIUM!,
        amount: 3990,  // $39.90
        currency: 'USD',
        allowPromotionCode: true,
      },
    },
    enterprise: {
      id: 'enterprise',
      popular: false,
      amount: 1000,
      expireDays: 30,
      price: {
        priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_CREDITS_ENTERPRISE!,
        amount: 6990,  // $69.90
        currency: 'USD',
        allowPromotionCode: true,
      },
    },
  },
}
```

## 订阅计划中的积分

每个订阅计划都可以包含月度积分：

```typescript
price: {
  plans: {
    free: {
      id: 'free',
      credits: {
        enable: true,
        amount: 50,      // 每月 50 积分
        expireDays: 30,  // 30 天后过期
      },
    },
    pro: {
      id: 'pro',
      credits: {
        enable: true,
        amount: 1000,    // 每月 1000 积分
        expireDays: 30,
      },
    },
    lifetime: {
      id: 'lifetime',
      credits: {
        enable: true,
        amount: 1000,    // 每月 1000 积分
        expireDays: 30,
      },
    },
  },
}
```

## 核心功能

### 1. 积分获取方式

#### 注册赠送
```typescript
// 在 src/lib/auth.ts 的 onCreateUser 钩子中
await addRegisterGiftCredits(user.id);
```

#### 订阅计划月度积分
```typescript
await addMonthlyFreeCredits(user.id, planId);
```

#### 购买积分包
通过 Stripe 支付购买积分包，webhook 处理后自动添加。

### 2. 积分消费

#### Server Action
```typescript
// src/actions/consume-credits.ts
export const consumeCreditsAction = userActionClient
  .schema(consumeSchema)
  .action(async ({ parsedInput, ctx }) => {
    // 扣除用户积分
  });
```

#### React Hook
```typescript
const { mutate: consumeCredits, isPending } = useConsumeCredits();

// 使用
consumeCredits({ 
  amount: 10, 
  description: "AI 文本生成" 
});
```

### 3. 积分查询

#### 获取余额
```typescript
const { data: balance, isLoading } = useCreditBalance();
// 返回: { balance: number }
```

#### 获取统计信息
```typescript
const { data: stats, isLoading } = useCreditStats();
```

#### 获取交易记录
```typescript
const { data: transactions, isLoading } = useCreditTransactions(
  pageIndex,
  pageSize,
  search,
  sorting
);
```

## 积分管理页面

### 路由
```
/[locale]/settings/credits
```

### 组件结构

```
src/components/settings/credits/
├── credit-packages.tsx              # 积分包展示
├── credit-checkout-button.tsx       # 购买按钮
├── credit-detail-viewer.tsx         # 积分详情查看器
├── credit-transactions-table.tsx    # 交易记录表格
├── credit-transactions.tsx          # 交易记录组件
├── credits-card.tsx                 # 积分卡片
└── credits-page-client.tsx          # 积分页面客户端组件
```

### 页面功能

1. **余额显示**: 实时显示当前积分余额
2. **积分包购买**: 展示可购买的积分包
3. **交易历史**: 分页显示所有积分交易记录
4. **过滤搜索**: 支持按类型、日期筛选交易
5. **详情查看**: 查看每笔交易的详细信息

## 积分过期机制

### 过期规则

1. 每笔积分都有独立的过期时间
2. 过期时间在添加积分时设置（expireDays）
3. 消费时优先使用即将过期的积分（FIFO）

### 过期处理

系统需要定期运行脚本处理过期积分：

```typescript
// 伪代码示例
async function processExpiredCredits() {
  const expiredTransactions = await db
    .select()
    .from(creditTransaction)
    .where(
      and(
        lt(creditTransaction.expirationDate, new Date()),
        isNull(creditTransaction.expirationDateProcessedAt)
      )
    );
  
  // 处理过期积分
  for (const transaction of expiredTransactions) {
    // 扣除过期积分
    // 更新用户余额
    // 标记为已处理
  }
}
```

## 积分购买流程

### 1. 用户选择积分包
```tsx
<CreditCheckoutButton
  userId={user.id}
  packageId="standard"
  priceId={process.env.NEXT_PUBLIC_STRIPE_PRICE_CREDITS_STANDARD!}
  metadata={{ userId: user.id }}
>
  购买 200 积分
</CreditCheckoutButton>
```

### 2. 创建 Stripe Checkout Session
```typescript
// src/actions/create-credit-checkout-session.ts
export const createCreditCheckoutAction = userActionClient
  .schema(creditCheckoutSchema)
  .action(async ({ parsedInput, ctx }) => {
    // 创建 Stripe checkout session
    // 返回支付链接
  });
```

### 3. 支付完成后 Webhook 处理
```typescript
// src/app/api/webhooks/stripe/route.ts
// 监听 invoice.paid 事件
// 添加积分到用户账户
// 创建交易记录
```

### 4. 重定向到积分页面
支付完成后自动跳转到 `/settings/credits`

## Server Actions

### 消费积分
```typescript
// src/actions/consume-credits.ts
consumeCreditsAction({ amount: 10, description: "AI generation" })
```

### 获取余额
```typescript
// src/actions/get-credit-balance.ts
getCreditBalanceAction()
```

### 获取统计
```typescript
// src/actions/get-credit-stats.ts
getCreditStatsAction()
```

### 获取交易记录
```typescript
// src/actions/get-credit-transactions.ts
getCreditTransactionsAction({ pageIndex, pageSize, search, sorting })
```

## React Hooks

```typescript
// src/hooks/use-credits.ts

// 获取余额
const { data: balance } = useCreditBalance();

// 获取统计
const { data: stats } = useCreditStats();

// 消费积分
const { mutate: consumeCredits } = useConsumeCredits();

// 获取交易记录
const { data: transactions } = useCreditTransactions(0, 10);
```

## 积分使用场景

1. **AI 文本生成**: 每次生成消耗 N 积分
2. **AI 图片生成**: 每张图片消耗 N 积分
3. **AI 聊天**: 按 token 数量消耗积分
4. **文件处理**: 按文件大小消耗积分
5. **API 调用**: 按调用次数消耗积分

## 最佳实践

### 1. 积分消费前检查余额
```typescript
const balance = await getCreditBalance(userId);
if (balance < requiredAmount) {
  throw new Error('积分不足');
}
```

### 2. 使用事务确保一致性
```typescript
await db.transaction(async (tx) => {
  // 扣除积分
  // 创建交易记录
  // 执行业务逻辑
});
```

### 3. 记录详细的交易描述
```typescript
await consumeCredits({
  amount: 10,
  description: "AI 文本生成 - GPT-4 - 500 tokens"
});
```

### 4. 定期清理过期积分
设置定时任务（如每天凌晨）处理过期积分。

## 环境变量

```env
# Stripe 积分包价格 ID
NEXT_PUBLIC_STRIPE_PRICE_CREDITS_BASIC=price_xxx
NEXT_PUBLIC_STRIPE_PRICE_CREDITS_STANDARD=price_xxx
NEXT_PUBLIC_STRIPE_PRICE_CREDITS_PREMIUM=price_xxx
NEXT_PUBLIC_STRIPE_PRICE_CREDITS_ENTERPRISE=price_xxx
```

## 总结

MkSaaS 的积分系统提供了完整的积分生命周期管理，包括获取、消费、过期和交易记录。系统设计灵活，支持多种积分获取方式和消费场景，适合各类 SaaS 应用的计费需求。
