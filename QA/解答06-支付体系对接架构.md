# 问题6：支付体系对接架构是什么？

## 概述

MkSaaS 使用 **Stripe** 作为支付提供商，支持订阅支付和一次性支付两种模式，并集成了积分购买功能。

## 支付架构图

```
用户 → 前端按钮 → Server Action → Stripe API → Checkout Session
                                                      ↓
                                                  用户支付
                                                      ↓
                                              Stripe Webhook
                                                      ↓
                                          更新数据库 → 发送邮件
```

## 核心组件

### 1. 支付模块结构

```
src/payment/
├── types.ts                    # 类型定义
├── index.ts                    # 主接口
└── provider/
    └── stripe.ts              # Stripe 实现
```

### 2. Server Actions

```
src/actions/
├── create-checkout-session.ts          # 创建订阅 checkout
├── create-credit-checkout-session.ts   # 创建积分 checkout
├── create-customer-portal-session.ts   # 创建客户门户
├── check-payment-completion.ts         # 检查支付状态
└── get-current-plan.ts                 # 获取当前计划
```

### 3. API 路由

```
src/app/api/webhooks/stripe/route.ts    # Webhook 处理
```

## 支付类型

### 1. 订阅支付 (SUBSCRIPTION)

```typescript
{
  type: PaymentTypes.SUBSCRIPTION,
  priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY!,
  amount: 990,      // $9.90
  currency: 'USD',
  interval: PlanIntervals.MONTH,  // 或 YEAR
}
```

### 2. 一次性支付 (ONE_TIME)

```typescript
{
  type: PaymentTypes.ONE_TIME,
  priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_LIFETIME!,
  amount: 19900,    // $199.00
  currency: 'USD',
}
```

## 数据库设计

### Payment 表

```typescript
export const payment = pgTable("payment", {
  id: text("id").primaryKey(),
  priceId: text('price_id').notNull(),
  type: text('type').notNull(),              // SUBSCRIPTION | ONE_TIME
  scene: text('scene'),                       // lifetime | credit | subscription
  interval: text('interval'),                 // month | year
  userId: text('user_id').notNull(),
  customerId: text('customer_id').notNull(),  // Stripe Customer ID
  subscriptionId: text('subscription_id'),    // Stripe Subscription ID
  sessionId: text('session_id'),              // Stripe Session ID
  invoiceId: text('invoice_id').unique(),     // Stripe Invoice ID
  status: text('status').notNull(),           // active | canceled | past_due
  paid: boolean('paid').notNull().default(false),
  periodStart: timestamp('period_start'),
  periodEnd: timestamp('period_end'),
  cancelAtPeriodEnd: boolean('cancel_at_period_end'),
  trialStart: timestamp('trial_start'),
  trialEnd: timestamp('trial_end'),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
});
```

## 支付流程

### 订阅支付流程

#### 1. 用户选择计划

```tsx
<CheckoutButton
  userId={user.id}
  planId="pro"
  priceId={process.env.NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY!}
  metadata={{ userId: user.id }}
>
  订阅 Pro 计划
</CheckoutButton>
```

#### 2. 创建 Checkout Session

```typescript
// src/actions/create-checkout-session.ts
export const createCheckoutAction = userActionClient
  .schema(checkoutSchema)
  .action(async ({ parsedInput, ctx }) => {
    const { priceId, planId, metadata } = parsedInput;
    const userId = ctx.user.id;
    
    // 创建或获取 Stripe Customer
    let customerId = ctx.user.customerId;
    if (!customerId) {
      const customer = await stripe.customers.create({
        email: ctx.user.email,
        name: ctx.user.name,
        metadata: { userId },
      });
      customerId = customer.id;
      
      // 更新用户记录
      await db.update(user)
        .set({ customerId })
        .where(eq(user.id, userId));
    }
    
    // 创建 Checkout Session
    const session = await stripe.checkout.sessions.create({
      customer: customerId,
      mode: 'subscription',  // 或 'payment'
      line_items: [{
        price: priceId,
        quantity: 1,
      }],
      success_url: `${baseUrl}/payment?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${baseUrl}/pricing`,
      metadata: {
        userId,
        planId,
        ...metadata,
      },
    });
    
    return {
      success: true,
      data: {
        url: session.url,
        id: session.id,
      },
    };
  });
```

#### 3. 用户完成支付

用户在 Stripe Checkout 页面完成支付。

#### 4. Webhook 处理

```typescript
// src/app/api/webhooks/stripe/route.ts
export async function POST(req: Request) {
  const body = await req.text();
  const signature = req.headers.get('stripe-signature')!;
  
  let event: Stripe.Event;
  
  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    );
  } catch (err) {
    return NextResponse.json(
      { error: 'Webhook signature verification failed' },
      { status: 400 }
    );
  }
  
  // 处理不同的事件
  switch (event.type) {
    case 'checkout.session.completed':
      await handleCheckoutCompleted(event.data.object);
      break;
      
    case 'customer.subscription.created':
      await handleSubscriptionCreated(event.data.object);
      break;
      
    case 'customer.subscription.updated':
      await handleSubscriptionUpdated(event.data.object);
      break;
      
    case 'customer.subscription.deleted':
      await handleSubscriptionDeleted(event.data.object);
      break;
      
    case 'invoice.paid':
      await handleInvoicePaid(event.data.object);
      break;
      
    case 'invoice.payment_failed':
      await handleInvoicePaymentFailed(event.data.object);
      break;
  }
  
  return NextResponse.json({ received: true });
}
```

#### 5. 更新数据库

```typescript
async function handleInvoicePaid(invoice: Stripe.Invoice) {
  const subscriptionId = invoice.subscription as string;
  const customerId = invoice.customer as string;
  
  // 查找用户
  const userRecord = await db
    .select()
    .from(user)
    .where(eq(user.customerId, customerId))
    .limit(1);
  
  if (!userRecord.length) return;
  
  const userId = userRecord[0].id;
  
  // 创建或更新支付记录
  await db.insert(payment).values({
    id: nanoid(),
    userId,
    customerId,
    subscriptionId,
    invoiceId: invoice.id,
    priceId: invoice.lines.data[0].price?.id!,
    type: 'SUBSCRIPTION',
    status: 'active',
    paid: true,
    periodStart: new Date(invoice.period_start * 1000),
    periodEnd: new Date(invoice.period_end * 1000),
    createdAt: new Date(),
    updatedAt: new Date(),
  }).onConflictDoUpdate({
    target: payment.invoiceId,
    set: {
      status: 'active',
      paid: true,
      updatedAt: new Date(),
    },
  });
  
  // 添加订阅积分（如果配置了）
  const plan = getPlanByPriceId(invoice.lines.data[0].price?.id!);
  if (plan?.credits?.enable) {
    await addSubscriptionCredits(userId, plan.id);
  }
}
```

### 积分购买流程

#### 1. 用户选择积分包

```tsx
<CreditCheckoutButton
  userId={user.id}
  packageId="standard"
  priceId={process.env.NEXT_PUBLIC_STRIPE_PRICE_CREDITS_STANDARD!}
  metadata={{ userId: user.id }}
>
  购买 200 积分
</CreditCheckoutButton>
```

#### 2. 创建 Checkout Session

```typescript
// src/actions/create-credit-checkout-session.ts
export const createCreditCheckoutAction = userActionClient
  .schema(creditCheckoutSchema)
  .action(async ({ parsedInput, ctx }) => {
    const session = await stripe.checkout.sessions.create({
      customer: ctx.user.customerId,
      mode: 'payment',  // 一次性支付
      line_items: [{
        price: parsedInput.priceId,
        quantity: 1,
      }],
      success_url: `${baseUrl}/payment?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${baseUrl}/settings/credits`,
      metadata: {
        userId: ctx.user.id,
        packageId: parsedInput.packageId,
        scene: 'credit',
      },
    });
    
    return {
      success: true,
      data: {
        url: session.url,
        id: session.id,
      },
    };
  });
```

#### 3. Webhook 添加积分

```typescript
async function handleInvoicePaid(invoice: Stripe.Invoice) {
  const metadata = invoice.metadata;
  
  if (metadata.scene === 'credit') {
    const creditPackage = getCreditPackage(metadata.packageId);
    
    // 添加积分
    await addCredits({
      userId: metadata.userId,
      amount: creditPackage.amount,
      description: `购买积分包: ${creditPackage.id}`,
      expirationDays: creditPackage.expireDays,
      paymentId: invoice.id,
    });
  }
}
```

## 客户门户

### 创建门户 Session

```typescript
// src/actions/create-customer-portal-session.ts
export const createPortalAction = userActionClient
  .schema(portalSchema)
  .action(async ({ parsedInput, ctx }) => {
    const session = await stripe.billingPortal.sessions.create({
      customer: ctx.user.customerId!,
      return_url: `${baseUrl}${parsedInput.returnUrl}`,
    });
    
    return {
      success: true,
      data: { url: session.url },
    };
  });
```

### 门户功能

- 查看订阅详情
- 更新支付方式
- 查看发票历史
- 取消订阅
- 更新订阅计划

## 支付状态检查

### 轮询检查支付完成

```typescript
// src/hooks/use-payment-completion.ts
export function usePaymentCompletion(
  sessionId: string | null,
  enablePolling: boolean = false
) {
  return useQuery({
    queryKey: ['payment-completion', sessionId],
    queryFn: async () => {
      const result = await checkPaymentCompletionAction({ sessionId: sessionId! });
      return result?.data;
    },
    enabled: !!sessionId && enablePolling,
    refetchInterval: (data) => {
      // 如果已支付，停止轮询
      if (data?.isPaid) return false;
      // 否则每2秒轮询一次
      return 2000;
    },
  });
}
```

## 环境变量

```env
# Stripe 密钥
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Stripe 公开密钥
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...

# 订阅计划价格 ID
NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY=price_...
NEXT_PUBLIC_STRIPE_PRICE_PRO_YEARLY=price_...
NEXT_PUBLIC_STRIPE_PRICE_LIFETIME=price_...

# 积分包价格 ID
NEXT_PUBLIC_STRIPE_PRICE_CREDITS_BASIC=price_...
NEXT_PUBLIC_STRIPE_PRICE_CREDITS_STANDARD=price_...
NEXT_PUBLIC_STRIPE_PRICE_CREDITS_PREMIUM=price_...
NEXT_PUBLIC_STRIPE_PRICE_CREDITS_ENTERPRISE=price_...
```

## Stripe 配置步骤

### 1. 创建产品和价格

在 Stripe Dashboard 中：
1. 创建产品（Product）
2. 为每个产品创建价格（Price）
3. 复制价格 ID 到环境变量

### 2. 配置 Webhook

1. 在 Stripe Dashboard 中添加 Webhook 端点
2. URL: `https://yourdomain.com/api/webhooks/stripe`
3. 选择监听的事件：
   - `checkout.session.completed`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.paid`
   - `invoice.payment_failed`
4. 复制 Webhook 签名密钥到环境变量

### 3. 测试模式

使用 Stripe CLI 在本地测试：

```bash
# 安装 Stripe CLI
brew install stripe/stripe-cli/stripe

# 登录
stripe login

# 转发 webhook 到本地
stripe listen --forward-to localhost:3000/api/webhooks/stripe

# 触发测试事件
stripe trigger checkout.session.completed
```

## 支付安全

### 1. Webhook 签名验证

```typescript
const event = stripe.webhooks.constructEvent(
  body,
  signature,
  process.env.STRIPE_WEBHOOK_SECRET!
);
```

### 2. 幂等性处理

使用 `invoiceId` 作为唯一约束，防止重复处理：

```typescript
.onConflictDoUpdate({
  target: payment.invoiceId,
  set: { /* 更新字段 */ },
})
```

### 3. 元数据验证

验证 webhook 中的 `userId` 和 `metadata`：

```typescript
if (metadata.userId !== expectedUserId) {
  throw new Error('Invalid user ID');
}
```

## 错误处理

### 1. 支付失败

```typescript
case 'invoice.payment_failed':
  await handleInvoicePaymentFailed(invoice);
  // 发送邮件通知用户
  // 更新订阅状态为 past_due
  break;
```

### 2. 订阅取消

```typescript
case 'customer.subscription.deleted':
  await handleSubscriptionDeleted(subscription);
  // 更新数据库状态
  // 移除用户权限
  break;
```

### 3. 超时处理

在 `vercel.json` 中配置 API 超时：

```json
{
  "functions": {
    "src/app/api/**/*": {
      "maxDuration": 300
    }
  }
}
```

## 测试支付

### 测试卡号

- **成功**: 4242 4242 4242 4242
- **需要 3D 验证**: 4000 0027 6000 3184
- **余额不足**: 4000 0000 0000 9995
- **被拒绝**: 4000 0000 0000 0002

## 总结

MkSaaS 的支付体系架构：

1. **前端**: Checkout 按钮 → Server Action
2. **后端**: Stripe API → Checkout Session
3. **支付**: 用户在 Stripe 页面完成支付
4. **Webhook**: Stripe 通知支付结果
5. **处理**: 更新数据库、添加积分、发送邮件

支持订阅支付、一次性支付和积分购买三种场景，通过 Webhook 确保支付状态的准确性和一致性。
